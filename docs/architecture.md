# 🏗️ 系统架构设计

## 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     用户交互层                            │
│  ┌──────────────┐              ┌──────────────┐         │
│  │  Web前端     │              │  桌面端      │         │
│  │  (Vue 3)     │              │  (Electron)  │         │
│  └──────────────┘              └──────────────┘         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   API服务层 (FastAPI)                    │
│  ┌──────────┬──────────┬──────────┬──────────┐         │
│  │ 创作API  │ 管理API  │ 校验API  │ 工具API  │         │
│  └──────────┴──────────┴──────────┴──────────┘         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   智能体编排层 (LangGraph)               │
│  ┌──────────┬──────────┬──────────┬──────────┐         │
│  │ 理解Agent│ 生成Agent│  管理Agent│ 校验Agent│         │
│  └──────────┴──────────┴──────────┴──────────┘         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   核心能力层                             │
│  ┌──────────┬──────────┬──────────┬──────────┐         │
│  │ 长文本   │ 逻辑校验 │ 风格学 习 │ 知识管理 │         │
│  │ 记忆引擎 │ 引擎     │ 引擎     │ 引擎     │         │
│  └──────────┴──────────┴──────────┴──────────┘         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   数据存储层                             │
│  ┌──────────┬──────────┬──────────┬──────────┐         │
│  │ SQLite/  │ 向量数据库│ 知识图谱 │ 文件存储 │         │
│  │ PostgreSQL│ (Chroma) │ (可选)   │ (本地)   │         │
│  └──────────┴──────────┴──────────┴──────────┘         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   大模型接入层 (可插拔)                  │
│  ┌──────────┬──────────┬──────────┬──────────┐         │
│  │ OpenAI   │ Claude   │ 通义千问 │ 本地模型 │         │
│  │ API      │ API      │ API      │ (Ollama) │         │
│  └──────────┴──────────┴──────────┴──────────┘         │
└─────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 三级总结系统（Hierarchical Summarizer）

#### L1：章节总结
- 输入：单章节内容
- 输出：200字以内的章节摘要
- 功能：快速总结、实体提取、事件提取

#### L2：卷册总结
- 输入：章节总结集合
- 输出：500字以内的卷册梗概
- 功能：脉络梳理、冲突演进、人物成长

#### L3：全文总结
- 输入：卷册总结集合
- 输出：1000字以内的全文总览
- 功能：整体脉络、多线索汇聚、世界观总结

### 2. 双层知识管理（Knowledge Manager）

#### 核心信息（Core）
- 存储方式：数据库 + 向量库
- 生命周期：永久存储
- 应用场景：人物设定、世界观、主线情节
- 特性：可锁定、不可自动覆盖

#### 即时信息（Ephemeral）
- 存储方式：Redis缓存
- 生命周期：7天自动过期
- 应用场景：场景细节、临时描写
- 特性：自动清理、快速检索

### 3. 智能体编排系统（Agent Orchestrator）

#### 理解Agent
- 职责：解析用户意图
- 输出：结构化任务描述

#### 生成Agent
- 职责：根据上下文生成内容
- 输出：小说文本

#### 管理Agent
- 职责：维护知识库和总结
- 输出：更新数据库

#### 校验Agent
- 职责：检查逻辑一致性
- 输出：校验报告、修改建议

### 4. 逻辑校验引擎（Logic Validator）

#### 校验维度
1. 设定一致性：是否违背已设定
2. 人物OOC：行为是否符合性格
3. 逻辑漏洞：是否有故事漏洞
4. 常识错误：是否有常识性错误

### 5. 大模型接入层（LiteLLM Client）

#### 支持的模型
- OpenAI: GPT-4, GPT-4-Turbo, GPT-3.5-Turbo
- Anthropic: Claude 3.5 Sonnet, Claude 3 Opus
- 通义千问: Qwen-Max, Qwen-Plus
- Ollama: 任何本地模型

#### 核心功能
- 模型自动路由
- Token计数
- 流式生成
- JSON输出

## 数据流

### 生成流程
```
用户输入
   ↓
理解Agent（意图解析）
   ↓
知识管理器（检索上下文）
   ↓
生成Agent（LLM生成）
   ↓
校验Agent（逻辑检查）
   ↓
（是否需要修改？）
   ├─ 是 → 优化Agent（迭代改进） → 校验Agent
   └─ 否 → 输出结果
   ↓
保存到数据库
   ↓
更新向量库
   ↓
用户获取结果
```

### 总结流程
```
新增内容
   ↓
自动触发章节总结（L1）
   ↓
积累达到卷数量 → 自动触发卷册总结（L2）
   ↓
完成新卷 → 自动触发全文总结（L3）
   ↓
更新知识库
```

## 数据库设计

### 核心表结构
- **Novel**: 小说信息
- **Volume**: 卷册信息
- **Chapter**: 章节信息
- **Summary**: 三级总结
- **Knowledge**: 知识条目
- **KnowledgeIndex**: 知识索引
- **GenerationHistory**: 生成历史

## 部署架构

### Docker容器化
```
docker-compose.yml
├── backend (FastAPI)
├── frontend (Vue 3)
├── redis (缓存)
└── 可选：postgres（扩展性）
```

### 数据持久化
```
./data/
├── novel_assistant.db（SQLite）
├── vector_store/（Chroma向量库）
└── redis/（Redis数据）
```

## 性能优化方向

1. **向量检索优化**
   - 使用HNSW索引加速
   - 分片检索减少延迟

2. **缓存策略**
   - Redis多层缓存
   - 热点数据预加载

3. **LLM调用优化**
   - 提示词模板缓存
   - Token计数优化
   - 流式传输

4. **数据库优化**
   - SQLite/PostgreSQL选择
   - 连接池管理
   - 查询优化

## 扩展点

1. **模型扩展**
   - 支持新的LLM提供商
   - 微调模型集成

2. **功能扩展**
   - 插件系统
   - 自定义Agent开发

3. **存储扩展**
   - 支持云存储（S3）
   - 多数据库后端

4. **集成扩展**
   - 第三方API集成
   - 多端同步
